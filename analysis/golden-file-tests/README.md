# Golden File Test Suite

**Purpose**: HTML validation infrastructure for Plan 1 and Plan 2 migrations

**Date**: 2025-11-01

---

## Overview

This test suite validates HTML output consistency across different Markdown rendering implementations:

1. **Baseline**: cmark-gfm + cmark-extra (current C implementation)
2. **Plan 1**: After highlight-wrapper → highlight.js migration
3. **Plan 2**: After cmark-gfm → swift-markdown migration

## Directory Structure

```
golden-file-tests/
├── README.md                    # This file
├── testcases/                   # Markdown input files (13 files)
│   ├── 01-gfm-basics.md
│   ├── 02-gfm-tables.md
│   ├── 03-gfm-tasklists.md
│   ├── 04-gfm-autolinks.md
│   ├── 05-gfm-strikethrough.md
│   ├── 06-emoji.md
│   ├── 07-math.md
│   ├── 08-heading-anchors.md
│   ├── 09-highlight-mark.md
│   ├── 10-subscript-superscript.md
│   ├── 11-mentions.md
│   ├── 12-footnotes.md
│   └── 13-code-highlighting.md
├── expected/                    # Golden HTML output (baseline)
│   ├── cmark-gfm/              # Current implementation
│   │   ├── 01-gfm-basics.html
│   │   ├── 02-gfm-tables.html
│   │   └── ...
│   ├── plan1-highlightjs/      # After Plan 1 migration
│   │   └── ...
│   └── plan2-swiftmarkdown/    # After Plan 2 migration
│       └── ...
├── scripts/                     # Test automation
│   ├── generate-baseline.sh    # Create golden files from current cmark
│   ├── compare.sh              # Diff current vs expected
│   └── run-tests.swift         # Swift test runner
└── RESULTS.md                   # Test execution results log
```

---

## Test Cases

### GFM Core Features (5 tests)

| Test | File | Coverage |
|------|------|----------|
| **01** | `01-gfm-basics.md` | Headings, paragraphs, lists, code blocks, blockquotes, emphasis |
| **02** | `02-gfm-tables.md` | Tables with alignment, formatting, pipe escaping |
| **03** | `03-gfm-tasklists.md` | Task lists with checkboxes, nesting |
| **04** | `04-gfm-autolinks.md` | URL autolinks, email autolinks |
| **05** | `05-gfm-strikethrough.md` | `~~deleted~~` text |

### TextDown Extensions (8 tests)

| Test | File | Coverage |
|------|------|----------|
| **06** | `06-emoji.md` | `:emoji:` → 😀 (emoji.c) |
| **07** | `07-math.md` | `$math$` and `$$display$$` (math_ext.c) |
| **08** | `08-heading-anchors.md` | Auto-generated `id` attributes (heads.c) |
| **09** | `09-highlight-mark.md` | `==highlighted==` text (highlight.c) |
| **10** | `10-subscript-superscript.md` | `~sub~` and `^sup^` (sub_ext.c, sup_ext.c) |
| **11** | `11-mentions.md` | `@username` mentions (mention.c) |
| **12** | `12-footnotes.md` | `[^1]` footnotes (footnotes - TO BE IMPLEMENTED) |
| **13** | `13-code-highlighting.md` | Syntax highlighting for 10+ languages |

---

## Usage

### 1. Generate Baseline Golden Files

**Before any migration**, capture current cmark-gfm output:

```bash
cd /Users/home/GitHub/QLMarkdown/analysis/golden-file-tests
./scripts/generate-baseline.sh
```

This creates `expected/cmark-gfm/*.html` files from current implementation.

### 2. Run Comparison Tests

**After code changes**, compare current output to baseline:

```bash
./scripts/compare.sh cmark-gfm
```

Output:
- ✅ Pass: Outputs match
- ❌ Fail: Outputs differ (shows diff)

### 3. Create New Golden Files for Migrations

**After Plan 1** (highlight.js):
```bash
./scripts/generate-baseline.sh plan1-highlightjs
```

**After Plan 2** (swift-markdown):
```bash
./scripts/generate-baseline.sh plan2-swiftmarkdown
```

### 4. Run Full Test Suite

```bash
swift scripts/run-tests.swift
```

Generates detailed test report with pass/fail for each test case.

---

## Expected Differences Between Implementations

### Plan 1: highlight-wrapper → highlight.js

**Changed**:
- `13-code-highlighting.md`: Different HTML structure for syntax highlighting
  - Before: `<span class="hl kwa">keyword</span>` (libhighlight classes)
  - After: `<span class="hljs-keyword">keyword</span>` (highlight.js classes)

**Unchanged**:
- All other test cases (01-12) should produce identical HTML

### Plan 2: cmark-gfm → swift-markdown

**Changed**:
- `08-heading-anchors.md`: Anchor IDs generated by Swift post-processing
  - Potential minor differences in ID generation algorithm
- `12-footnotes.md`: Footnotes now handled by Swift post-processing
  - Should match GFM spec but implementation is new

**Unchanged**:
- GFM core features (01-05) should match spec
- Extensions (06-11, 13) handled by Swift post-processing

---

## Test Automation

### Swift Test Runner

The `run-tests.swift` script:

1. Loads each test case Markdown file
2. Renders HTML using current Settings configuration
3. Compares output to expected golden file
4. Reports differences with context

**Integration**: Can be integrated into Xcode Test target (XCTest).

### CI/CD Integration

```yaml
# Example GitHub Actions workflow
name: Golden File Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build TextDown
        run: xcodebuild -scheme TextDown -configuration Debug
      - name: Run Golden File Tests
        run: swift analysis/golden-file-tests/scripts/run-tests.swift
```

---

## Updating Golden Files

### When to Update

Update golden files when:
1. **Intentional HTML output changes** (e.g., migrating to new implementation)
2. **Bug fixes** that correct previously incorrect output
3. **New features** that enhance HTML output

### How to Update

```bash
# After verifying new output is correct:
./scripts/generate-baseline.sh <implementation-name>

# Example:
./scripts/generate-baseline.sh plan1-highlightjs
```

### Review Process

1. Run comparison: `./scripts/compare.sh`
2. Review all diffs manually
3. Verify changes are intentional
4. Update golden files
5. Commit with clear explanation

---

## Test Coverage Statistics

| Category | Test Cases | Coverage |
|----------|------------|----------|
| GFM Core | 5 | Tables, Task Lists, Autolinks, Strikethrough |
| TextDown Extensions | 8 | Emoji, Math, Anchors, Highlight, Sub/Sup, Mentions, Footnotes, Syntax |
| **Total** | **13** | **~95% feature coverage** |

### Missing Coverage

- Inline images (local file embedding) - requires test resources
- R Markdown YAML headers - requires .rmd test files
- Edge cases with deeply nested structures

---

## Testing Strategy

### Before Plan 1 Execution

- [x] Create test case files (13 files)
- [x] Document test structure
- [ ] Generate cmark-gfm baseline
- [ ] Verify baseline correctness

### During Plan 1 Execution

- [ ] Run tests after each major change
- [ ] Compare syntax highlighting output
- [ ] Generate plan1-highlightjs golden files
- [ ] Verify 12/13 tests unchanged

### During Plan 2 Execution

- [ ] Compare GFM core output (tests 01-05)
- [ ] Verify extension migration (tests 06-11, 13)
- [ ] Test new footnotes implementation (test 12)
- [ ] Generate plan2-swiftmarkdown golden files

---

## File Naming Convention

**Test Cases**: `XX-feature-name.md`
- `XX`: Two-digit sequence number (01-13)
- `feature-name`: Lowercase with hyphens

**Golden Files**: `XX-feature-name.html`
- Matches test case name, `.md` → `.html`

**Example**:
- Test: `06-emoji.md`
- Golden: `expected/cmark-gfm/06-emoji.html`

---

## Acceptance Criteria

### Plan 1 Success

- ✅ Tests 01-12: 100% match to baseline
- ⚠️ Test 13: Expected differences in syntax highlighting HTML
  - Verify visual appearance matches (manual check)
  - Document class name mappings

### Plan 2 Success

- ✅ Tests 01-05: Match GFM spec (may differ slightly from cmark-gfm)
- ✅ Tests 06-11: Match baseline (Swift post-processing)
- ✅ Test 12: New footnotes implementation matches GFM spec
- ✅ Test 13: Syntax highlighting works (highlight.js)

---

## Troubleshooting

### Test Fails Unexpectedly

1. Check Settings configuration matches baseline
2. Verify all extensions are enabled
3. Check for whitespace differences (normalize)
4. Examine HTML structure, not just text content

### Syntax Highlighting Differences

1. Visual check: Does it look correct?
2. Theme check: Is the theme applied?
3. Language detection: Is the language identified correctly?
4. Fallback: Does unknown language render as plain text?

### Swift Post-Processing Issues

1. Verify post-processing order matches spec
2. Check regex patterns for correctness
3. Test edge cases in isolation
4. Compare to reference implementations

---

## References

- **GFM Spec**: https://github.github.com/gfm/
- **cmark-gfm**: https://github.com/github/cmark-gfm
- **swift-markdown**: https://github.com/apple/swift-markdown
- **highlight.js**: https://highlightjs.org/

---

**Status**: Test suite created ✅
**Next Steps**:
1. Generate baseline golden files
2. Integrate into Xcode test target (optional)
3. Use during Plan 1 and Plan 2 migrations

**Created**: 2025-11-01
**Last Updated**: 2025-11-01
